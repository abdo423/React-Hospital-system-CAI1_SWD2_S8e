<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Doctor</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .edit-doctor-form {
        max-width: 600px;
        margin: 50px auto;
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      }
      .form-group img {
        margin-top: 10px;
        max-width: 100px;
      }
      #previewImage {
        margin-top: 10px;
        display: none; /* Initially hidden */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="edit-doctor-form">
        <h1 class="text-center mb-4">Edit Doctor</h1>

        <form id="editDoctorForm" enctype="multipart/form-data">
          <% if (errors.length > 0) { %>
            <div class="alert alert-danger">
              <ul>
                <% errors.forEach(function(error) { %>
                  <li><%= error %></li>
                <% }); %>
              </ul>
            </div>
          <% } %>
          <div class="form-group mb-3">
            <label for="name" class="form-label">Name</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              value="<%= doctor.name %>"
            />
          </div>
          <div class="form-group mb-3">
            <label for="phone" class="form-label">Phone</label>
            <input
              type="text"
              class="form-control"
              id="phone"
              name="phone"
              value="<%= doctor.phone %>"
            />
          </div>
          <div class="form-group mb-3">
            <label for="email" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="email"
              name="email"
              value="<%= doctor.email %>"
            />
          </div>
          <div class="form-group mb-3">
            <label for="department" class="form-label">Department</label>
            <select class="form-select" id="department" name="department">
              <option value="<%= doctor.department._id %>">
                <%= doctor.department.name %>
              </option>
              <!-- Add other departments here -->
            </select>
          </div>
          <div class="form-group mb-3">
            <label for="doctorImage" class="form-label">Doctor Image</label>
            <input
              type="file"
              class="form-control"
              id="doctorImage"
              name="doctorImage"
              accept="image/*"
            />
            <img id="previewImage" alt="Preview Image" />
            <img
              src="/<%= doctor.DoctorImage %>"
              alt="Doctor Image"
              width="100"
              class="mt-2"
              id="currentImage"
            />
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Event listener for the image input field to show a preview of the selected image
      document
        .getElementById("doctorImage")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const previewImage = document.getElementById("previewImage");
              previewImage.src = e.target.result;
              previewImage.style.display = "block"; // Show the preview image
              document.getElementById("currentImage").style.display = "none"; // Hide the current image
            };
            reader.readAsDataURL(file);
          }
        });

      // Submit form via fetch
      document
        .getElementById("editDoctorForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent the default form submission

          const form = document.getElementById("editDoctorForm");
          const formData = new FormData(form);
          const doctorId = "<%= doctor._id %>";

          try {
            const response = await fetch(`/api/doctors/${doctorId}`, {
              method: "PUT",
              body: formData,
            });

            if (response.ok) {
              alert("Doctor updated successfully");
              window.location.href = "/api/doctors"; // Redirect to doctors list
            } else {
              const textResponse = await response.text();
              let errorData;

              try {
                errorData = JSON.parse(textResponse);
              } catch (jsonError) {
                errorData = ["Failed to parse error response"];
              }
              alert("Failed to update doctor: " + textResponse);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while updating the doctor");
          }
        });
      async function loadDepartments() {
        try {
          const response = await fetch("/departments"); // Adjust the URL to match your API route
          if (response.ok) {
            const departments = await response.json();

            // Get the select element
            const departmentSelect = document.getElementById("department");

            // Loop over the departments and create options
            departments.forEach((department) => {
              const option = document.createElement("option");
              option.value = department._id; // Assuming the department has an _id field
              option.textContent = department.name; // Assuming the department has a name field
              departmentSelect.appendChild(option);
            });
          } else {
            console.error("Failed to fetch departments:", response.statusText);
          }
        } catch (error) {
          console.error("Error fetching departments:", error);
        }
      }

      // Call the function to load the departments on page load
      window.onload = loadDepartments;
    </script>
  </body>
</html>